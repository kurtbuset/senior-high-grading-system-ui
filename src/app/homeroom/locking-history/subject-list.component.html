<div class="container mt-4">
  <h2 class="mb-4 text-primary">üìå Locked Subjects History</h2>

  <div class="table-responsive shadow-sm rounded">
    <table class="table table-hover align-middle">
      <thead class="table-primary text-center">
        <tr>
          <th style="width: 5%">#</th>
          <th style="width: 25%">Subject Name</th>
          <th style="width: 10%">Semester</th>
          <th style="width: 10%">Quarter</th>
          <th style="width: 20%">Subject Teacher</th>
          <th style="width: 10%">Status</th>
        </tr>
      </thead>
      <tbody>
        <ng-container *ngFor="let record of history">
          <!-- Subject Row -->
          <tr
            (click)="record.expanded = !record.expanded"
            class="table-light"
            style="cursor: pointer"
          >
            <td class="text-center">{{ record.assignment_id }}</td>
            <td class="fw-bold">{{ record.subject_name }}</td>
            <td class="text-center">{{ record.semester }}</td>
            <td class="text-center">{{ record.quarter }}</td>
            <td class="text-center">{{ record.teacher_name }}</td>
            <td class="text-center">
              <!-- Status badges -->
              <ng-container [ngSwitch]="record.lock_status">
                <!-- üîí Locked -->
                <span *ngSwitchCase="'LOCKED'" class="badge bg-danger">
                  üîí LOCKED
                </span>

                <!-- ‚è≥ Pending with View button -->
                <span
                  *ngSwitchCase="'PENDING'"
                  class="badge bg-warning text-dark"
                >
                  ‚è≥ PENDING
                </span>
                <button
                  *ngIf="
                    record.lock_status === 'PENDING' &&
                    account.role === 'Registrar'
                  "
                  class="btn btn-sm btn-warning ms-2"
                  (click)="openRequestModal(record)"
                >
                  View Request
                </button>

                <!-- ‚úÖ Unlocked -->
                <span *ngSwitchCase="'UNLOCKED'" class="badge bg-success">
                  ‚úÖ UNLOCKED
                </span>

                <!-- ‚ùî Unknown -->
                <span *ngSwitchDefault class="badge bg-secondary">
                  ‚ùî Unknown
                </span>
              </ng-container>
            </td>
          </tr>

          <!-- Expandable Locked Dates -->
          <tr *ngIf="record.expanded">
            <td colspan="6" class="p-3">
              <div class="d-flex flex-wrap gap-3">
                <div
                  *ngFor="let batch of record.locked_batches"
                  class="card border-primary shadow-sm flex-fill"
                  style="min-width: 280px; max-width: 350px"
                >
                  <div class="card-header bg-primary text-white py-2">
                    <strong>
                      üìÖ Locked at:
                      {{ batch.locked_at | date : "MMM d, y h:mm a" }}
                    </strong>
                  </div>
                  <div class="card-body p-0">
                    <table class="table table-bordered table-sm mb-0">
                      <thead class="table-light">
                        <tr>
                          <th style="width: 70%">Student Name</th>
                          <th style="width: 30%">Final Grade</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let student of batch.students">
                          <td>
                            {{ student.lastName }}, {{ student.firstName }}
                          </td>
                          <td class="text-center fw-bold">
                            <span
                              class="badge"
                              [ngClass]="{
                                'bg-success': student.final_grade >= 75,
                                'bg-danger': student.final_grade < 75
                              }"
                            >
                              {{ student.final_grade }}
                            </span>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        </ng-container>
      </tbody>
    </table>
  </div>
</div>

<!-- Request Modal (Angular-driven, no bootstrap JS) -->
<div
  class="modal fade"
  [ngClass]="{ show: showRequestModal }"
  [ngStyle]="{ display: showRequestModal ? 'block' : 'none' }"
  role="dialog"
  aria-modal="true"
>
  <div
    class="modal-dialog"
    style="
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    "
  >
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title">Unlock Request</h5>
        <button
          type="button"
          class="btn-close"
          (click)="closeRequestModal()"
        ></button>
      </div>
      <div class="modal-body">
        <p><strong>Reason:</strong></p>
        <ng-container *ngIf="selectedRecord?.reason_to_unlock; else noRequest">
          <p class="text-muted">{{ selectedRecord.reason_to_unlock }}</p>
        </ng-container>
        <ng-template #noRequest>
          <div
            style="
              padding: 1rem;
              background-color: #f8f9fa;
              border: 1px dashed #ccc;
              border-radius: 8px;
              text-align: center;
              color: #6c757d;
              font-style: italic;
            "
          >
            ‚úÖ No unlock request has been submitted by this subject teacher.
          </div>
        </ng-template>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          (click)="closeRequestModal()"
        >
          Close
        </button>

        <ng-container *ngIf="account.role === 'Registrar'">
          <button
            type="button"
            class="btn btn-success"
            (click)="respondToRequest('UNLOCKED')"
          >
            ‚úÖ Accept
          </button>
          <button
            type="button"
            class="btn btn-danger"
            (click)="respondToRequest('LOCKED')"
          >
            ‚ùå Reject
          </button>
        </ng-container>
      </div>
    </div>
  </div>
</div>

<div
  class="modal-backdrop fade"
  [ngClass]="{ show: showRequestModal }"
  *ngIf="showRequestModal"
></div>
