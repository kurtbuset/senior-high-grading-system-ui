<div
  style="
    max-width: 1200px;
    height: 500px;
    overflow: auto;
    margin: auto;
    width: 100%;
  "
>
  <table
    class="table table-hover table-sm text-center"
    *ngIf="sheet"
    style="border-collapse: collapse; min-width: max-content"
  >
    <thead>
      <tr>
        <th
          style="
            position: sticky;
            left: 0;
            top: 0;
            background: #fff;
            z-index: 3;
            min-width: 150px;
          "
        ></th>
        <th
          *ngFor="let subj of sheet.subjects; let i = index"
          colspan="3"
          class="subject-header subject-{{ i % 6 }}"
          [title]="
            subj.subject.name + (subj.teacher ? ' - ' + subj.teacher : '')
          "
        >
          <span class="subject-name d-flex flex-column">
            <span class="fw-bold">{{ subj.subject.name }}</span>
            <div
              class="w-100 d-flex justify-content-between align-items-center"
            >
              <!-- Default view mode -->
              <small class="text-muted">
                {{ subj.teacher || "No Teacher Assigned" }}
              </small>
              <button
                class="btn btn-sm btn-outline-primary mt-1"
                (click)="openTeacherModal(subj)"
              >
                {{ subj.teacher ? "Change Teacher" : "Assign Teacher" }}
              </button>
            </div>
          </span>
        </th>
      </tr>

      <!-- Second row: 1ST / 2ND / SFG -->
      <tr>
        <th
          style="
            position: sticky;
            left: 0;
            top: 30px;
            background: #fff;
            z-index: 3;
          "
        >
          Students
        </th>
        <ng-container *ngFor="let subj of sheet.subjects; let i = index">
          <th
            class="subject-col subject-{{ i % 6 }}"
            style="position: sticky; top: 30px; z-index: 2"
          >
            1ST
          </th>
          <th
            class="subject-col subject-{{ i % 6 }}"
            style="position: sticky; top: 30px; z-index: 2"
          >
            2ND
          </th>
          <th
            class="subject-col subject-{{ i % 6 }}"
            style="position: sticky; top: 30px; z-index: 2"
          >
            SFG
          </th>
        </ng-container>
      </tr>
    </thead>

    <tbody>
      <tr *ngFor="let student of sheet.students">
        <td
          style="
            position: sticky;
            left: 0;
            background: #fff;
            z-index: 1;
            min-width: 150px;
            text-align: left;
          "
        >
          {{ student.name }}
        </td>
        <ng-container *ngFor="let subj of sheet.subjects">
          <td>
            {{ student.grades[subj.curriculum_subject_id]?.first ?? " " }}
          </td>
          <td>
            {{ student.grades[subj.curriculum_subject_id]?.second ?? " " }}
          </td>
          <td>{{ student.grades[subj.curriculum_subject_id]?.ave ?? " " }}</td>
        </ng-container>
      </tr>
    </tbody>
  </table>
</div>

<div
  *ngIf="loading"
  class="d-flex justify-content-center align-items-center my-5"
  style="min-height: 150px"
>
  <div class="spinner-border text-primary" role="status"></div>
</div>
<!-- Teacher Assignment Modal -->
<div
  class="modal fade"
  tabindex="-1"
  [ngClass]="{ show: showTeacherModal }"
  [ngStyle]="{ display: showTeacherModal ? 'block' : 'none' }"
  role="dialog"
  aria-modal="true"
  *ngIf="selectedSubject"
>
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content shadow-lg rounded-3">
      <!-- Header -->
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title mb-0">
          {{ selectedSubject?.teacher ? "Change Teacher" : "Assign Teacher" }}
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          (click)="closeTeacherModal()"
        ></button>
      </div>

      <!-- Body -->
      <div class="modal-body">
        <div class="mb-3">
          <p class="mb-1 fw-semibold text-muted">Subject</p>
          <div class="p-2 border rounded bg-light fw-bold">
            {{ selectedSubject?.subject?.name }}
          </div>
        </div>

        <div class="mb-3">
          <label for="teacherSelect" class="form-label fw-semibold"
            >Select Teacher</label
          >
          <select
            id="teacherSelect"
            class="form-select"
            [(ngModel)]="selectedSubject.teacherId"
          >
            <option [ngValue]="null" disabled>-- Choose a teacher --</option>
            <option *ngFor="let t of teachers" [ngValue]="t.id">
              {{ t.firstName }} {{ t.lastName }}
            </option>
          </select>
        </div>
      </div>

      <!-- Footer -->
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" (click)="closeTeacherModal()">
          <i class="bi bi-x-circle me-1"></i> Cancel
        </button>
        <button
          class="btn btn-success"
          (click)="saveTeacherAssignment()"
          [disabled]="!selectedSubject?.teacherId"
        >
          <i class="bi bi-check-circle me-1"></i> Save
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Backdrop -->
<div
  class="modal-backdrop fade"
  [ngClass]="{ show: showTeacherModal }"
  *ngIf="showTeacherModal"
></div>
