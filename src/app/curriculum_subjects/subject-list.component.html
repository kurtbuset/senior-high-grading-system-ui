<h3 class="mb-3">Subjects Management</h3>

<!-- Filters -->
<div class="d-flex flex-column mb-4 p-3 border border-1 border-black rounded-3">
  <div>
    <h4>Filters</h4>
  </div>

  <div class="d-flex gap-3 flex-wrap">
    <div class="col">
      <label>Grade Level</label>
      <select class="form-control" [(ngModel)]="selectedGradeLevelId">
        <option value="">All</option>
        <option *ngFor="let g of gradeLevels" [value]="g.id">
          Grade {{ g.level }}
        </option>
      </select>
    </div>

    <div class="col">
      <label>Strand</label>
      <select class="form-control" [(ngModel)]="selectedStrandId">
        <option value="">All</option>
        <option *ngFor="let s of strands" [value]="s.id">{{ s.name }}</option>
      </select>
    </div>

    <div class="col">
      <label>Semester</label>
      <select class="form-control" [(ngModel)]="selectedSemester">
        <option value="">All</option>
        <option value="FIRST SEMESTER">1st Semester</option>
        <option value="SECOND SEMESTER">2nd Semester</option>
      </select>
    </div>

    <div class="col">
      <label>School Year</label>
      <select class="form-control" [(ngModel)]="selectedSchoolYearId">
        <option value="">All</option>
        <option *ngFor="let sy of schoolYears" [value]="sy.id">
          {{ sy.school_year }}
        </option>
      </select>
    </div>

    <div class="d-flex align-items-end gap-2">
      <button class="btn btn-primary btn-sm mr-3" (click)="applyFilters()">
        Apply
      </button>
      <button class="btn btn-secondary btn-sm" (click)="resetFilters()">
        Reset
      </button>
    </div>
  </div>
</div>

<!-- Dynamic Filter Header -->
<div *ngIf="filtersApplied" class="mb-2">
  <h5 class="text-primary">{{ currentFilterTextValue }}</h5>
</div>

<!-- Subject List -->
<table class="table table-hover table-sm">
  <thead>
    <tr>
      <th style="width: 10%">Code</th>
      <th style="width: 50%">Name</th>
      <th style="width: 20%">Type</th>
      <th style="width: 5%">Action</th>
    </tr>
  </thead>
  <tbody>
    <tr *ngIf="!filtersApplied">
      <td colspan="4" class="text-center py-5">
        <h4 class="text-muted">
          üîç Please apply filters to find matching subjects.
        </h4>
      </td>
    </tr>

    <tr *ngFor="let subj of filteredSubjects" [hidden]="!filtersApplied">
      <td>{{ subj.code }}</td>
      <td>{{ subj.name }}</td>
      <td>{{ subj.type }}</td>
      <td>
        <button class="btn btn-danger btn-sm" (click)="deleteSubject(subj.id)">
          <i class="bi bi-trash"></i>
        </button>
      </td>
    </tr>

    <tr
      *ngIf="
        filtersApplied && filteredSubjects.length === 0 && !showSetSubjectsModal
      "
    >
      <td colspan="5" class="text-center">
        <div
          class="d-flex flex-column justify-content-center align-items-center text-center p-4 border rounded-3 shadow-sm bg-light"
          style="min-height: 200px"
        >
          <p class="text-muted h3 mb-3">
            <i class="bi bi-journal-x me-2"></i> No Subjects Found.
          </p>
          <button
            class="btn btn-success btn-sm px-3 py-2"
            (click)="openSetSubjectsModal(); addSubject()"
          >
            <i class="bi bi-plus-circle me-1"></i> Set Subjects for this
            Curriculum
          </button>
        </div>
      </td>
    </tr>
  </tbody>
</table>

<div
  class="mt-3 d-flex justify-content-center"
  *ngIf="filtersApplied && filteredSubjects.length > 0"
>
  <button
    class="btn btn-success btn-sm"
    (click)="openSetSubjectsModal(); addSubject()"
  >
    <i class="bi bi-plus-circle me-1"></i> Add Subject
  </button>
</div>

<!-- Dynamic Set Subjects Section -->
<div
  *ngIf="showSetSubjectsModal"
  class="border rounded-3 p-3 mt-4 shadow-sm bg-white"
>
  <h4 class="mb-3">Set Subjects</h4>

  <div class="table-responsive">
    <table class="table table-bordered table-sm align-middle">
      <thead class="table-light">
        <tr>
          <th style="width: 40%">Subject</th>
          <th style="width: 10%">Action</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let subj of selectedSubjects; let i = index">
          <td>
            <select class="form-select" [(ngModel)]="subj.subject_id">
              <option value="">-- Select Subject --</option>
              <option *ngFor="let s of subjects" [value]="s.id">
                {{ s.name }} ------ <strong>{{ s.type }}</strong>
              </option>
            </select>
          </td>
          <td>
            <button class="btn btn-danger btn-sm" (click)="removeSubject(i)">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>

        <tr *ngIf="selectedSubjects.length === 0">
          <td colspan="2" class="text-center text-muted">
            No subjects added yet.
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="d-flex justify-content-between mt-3">
    <button class="btn btn-outline-primary btn-sm" (click)="addSubject()">
      <i class="bi bi-plus-circle"></i> Add Subject
    </button>

    <div>
      <button class="btn btn-success btn-sm me-2" (click)="saveSubjects()">
        <i class="bi bi-save me-1"></i> Save
      </button>
      <button class="btn btn-secondary btn-sm" (click)="closeModal()">
        Cancel
      </button>
    </div>
  </div>
</div>
